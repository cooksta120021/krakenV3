<!DOCTYPE html>
<html>
<head>
    <title>Positions</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background: #0b1220; color: #e8eefc; }
        .card { background: #141c2f; border: 1px solid #1f2a44; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .nav { position: sticky; top: 0; z-index: 99; background: #0b1220; padding: 8px 0; }
        h1, h2 { color: #f5f7ff; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 6px 8px; border-bottom: 1px solid #1f2a44; font-size: 13px; text-align: left; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="card nav">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
            <div>
                <a href="/">Dashboard</a> · <a href="/vaults/">Vaults</a> · <a href="/vaults/wallets/">Wallets</a> · <a href="/vaults/api-keys/">API Keys</a> · <a href="/vaults/positions/">Positions</a> · <a href="/vaults/admin/">Admin</a>{% if request.user.role == "admin" or request.user.role == "mod" %} · <a href="/accounts/approvals/">Approvals</a>{% endif %}
            </div>
            <div style="font-size:12px;">
                Role: <span class="pill">{{ request.user.role }}</span> · Approved: <span class="pill">{{ request.user.is_approved }}</span>
            </div>
        </div>
    </div>
    {% if live_balances %}
    <div class="card">
        <h3>Live Balances (Kraken)</h3>
        {% if live_balances.error %}<div style="color:#ff7b7b">{{ live_balances.error }}</div>{% else %}
        <ul>
            {% for asset, amount in live_balances.items %}
            <li>{{ asset }}: {{ amount }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    {% endif %}
    {% if live_positions %}
    <div class="card">
        <h3>Live Open Positions (Kraken)</h3>
        {% if live_positions.error %}<div style="color:#ff7b7b">{{ live_positions.error }}</div>{% else %}
        <ul>
            {% for pid, pos in live_positions.items %}
            <li><strong>{{ pid }}</strong>: {{ pos }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>
    {% endif %}
    {{ chart_map|json_script:"chart-map" }}
    {{ pnl_map|json_script:"pnl-map" }}
    <h1>Positions</h1>
    {% for sleeve in sleeves %}
    <div class="card">
        <h2>{{ sleeve.vault.asset }}/{{ sleeve.vault.quote_asset }} — {{ sleeve.sleeve_type|title }} {% if sleeve.sleeve_type == "flash" %}<span style="background:#ffcf5c;color:#0b1220;padding:2px 6px;border-radius:10px;font-size:12px;">Flash</span>{% else %}<span style="background:#6cb4ff;color:#0b1220;padding:2px 6px;border-radius:10px;font-size:12px;">Quiet</span>{% endif %}</h2>
        <p>Allocated: {{ sleeve.allocated_amount }} | Profit retained: {{ sleeve.profit_retained }} | Profit returned: {{ sleeve.profit_returned }} | Mode: {{ sleeve.mode }} | Active: {{ sleeve.is_active }}</p>
        <p>P&L: Realized {{ sleeve.latest_pnl.realized|default:"0" }} | Unrealized {{ sleeve.latest_pnl.unrealized|default:"0" }} | Fees {{ sleeve.latest_pnl.fees|default:"0" }} | Total Fees (fills) {{ sleeve.total_fees|default:"0" }}</p>
        <p>Position: Qty {{ sleeve.net_qty }} | Avg {{ sleeve.avg_price }} | Unrealized {{ sleeve.unrealized_position }} {% if sleeve.unrealized_position < 0 %}<span style="color:#ff7b7b">(Loss)</span>{% endif %}</p>
        {% if sleeve.unrealized_position < 0 %}
        <p style="color:#ff7b7b">Alert: Unrealized loss on this sleeve.</p>
        {% endif %}

        <h3>Price Chart ({{ sleeve.vault.asset }}{{ sleeve.vault.quote_asset }})</h3>
        <canvas id="chart-{{ sleeve.vault.asset }}{{ sleeve.vault.quote_asset }}" height="140"></canvas>
        <h3>P&L Chart</h3>
        <canvas id="pnl-{{ sleeve.id }}" height="140"></canvas>

        <h3>Orders</h3>
        <table>
            <thead><tr><th>When</th><th>Side</th><th>Amount</th><th>Price</th><th>Fees</th><th>Status</th></tr></thead>
            <tbody>
            {% for order in sleeve.orders.all %}
            <tr>
                <td>{{ order.created_at }}</td>
                <td>{{ order.side }}</td>
                <td>{{ order.amount }}</td>
                <td>{{ order.price }}</td>
                <td>{{ order.fees }}</td>
                <td>{{ order.status }}</td>
            </tr>
            {% empty %}<tr><td colspan="6">No orders yet.</td></tr>{% endfor %}
            </tbody>
        </table>

        <h3>Fills</h3>
        <table>
            <thead><tr><th>When</th><th>Amount</th><th>Price</th><th>Fee</th></tr></thead>
            <tbody>
            {% for order in sleeve.orders.all %}
                {% for fill in order.fills.all %}
                <tr>
                    <td>{{ fill.created_at }}</td>
                    <td>{{ fill.amount }}</td>
                    <td>{{ fill.price }}</td>
                    <td>{{ fill.fee }}</td>
                </tr>
                {% empty %}
                {% endfor %}
            {% empty %}<tr><td colspan="4">No fills yet.</td></tr>{% endfor %}
            </tbody>
        </table>
    </div>
    {% empty %}<p>No sleeves yet.</p>{% endfor %}

    <script>
        const chartMap = JSON.parse(document.getElementById('chart-map').textContent || '{}');
        const pnlMap = JSON.parse(document.getElementById('pnl-map')?.textContent || '{}');
        Object.entries(chartMap).forEach(([pair, data]) => {
            const canvas = document.getElementById(`chart-${pair}`);
            if (canvas && data.length > 0) {
                new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: pair,
                            data,
                            parsing: { xAxisKey: 'x', yAxisKey: 'y' },
                            borderColor: '#8ad5ff',
                            backgroundColor: 'rgba(138,213,255,0.1)',
                            tension: 0.2,
                        }]
                    },
                    options: {
                        plugins: { legend: { labels: { color: '#e8eefc' } } },
                        scales: { x: { ticks: { color: '#e8eefc' } }, y: { ticks: { color: '#e8eefc' } } }
                    }
                });
            }
        });

        Object.entries(pnlMap).forEach(([sleeveId, data]) => {
            const canvas = document.getElementById(`pnl-${sleeveId}`);
            if (canvas && data.length > 0) {
                new Chart(canvas.getContext('2d'), {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'P&L',
                            data,
                            parsing: { xAxisKey: 'x', yAxisKey: 'y' },
                            borderColor: '#9be37a',
                            backgroundColor: 'rgba(155,227,122,0.1)',
                            tension: 0.2,
                        }]
                    },
                    options: {
                        plugins: { legend: { labels: { color: '#e8eefc' } } },
                        scales: { x: { ticks: { color: '#e8eefc' } }, y: { ticks: { color: '#e8eefc' } } }
                    }
                });
            }
        });
    </script>
</body>
</html>
